<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta property="og:title" content="Integrix AI">
  <meta property="og:description" content="AI systems that scale businesses">
  <meta property="og:image" content="https://integrix.in/assets/og-image.png">
  <meta property="og:url" content="https://integrix.in">
  <meta property="og:type" content="website">

  <!--FAVICONS AND APP ICONS-->
  <link rel="icon" type="image/png" sizes="32x32" href="../assets/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../assets/favicon/favicon-16x16.png">
  <link rel="shortcut icon" href="../assets/favicon/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="../assets/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="../assets/favicon/android-chrome-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="../assets/favicon/android-chrome-512x512.png">

  <link rel="manifest" href="../assets/favicon/site.webmanifest">


  <title>VAPI Call Tracking Dashboard</title>

  <!-- Styles -->
  <link rel="stylesheet" href="styles.css">

  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Chart.js for Sparklines -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Wavesurfer.js for Audio Waveforms -->
  <script src="https://unpkg.com/wavesurfer.js@7"></script>
</head>

<body>
  <!-- Theme Initialization Script (Prevents flash of unstyled content) -->
  <script>
    (function () {
      const savedTheme = localStorage.getItem('integrix-theme') || 'dark';
      document.documentElement.setAttribute('data-theme', savedTheme);
    })();
  </script>

  <!-- Navigation (rendered dynamically) -->
  <div id="nav"></div>

  <!-- Main App Container -->
  <div id="app">
    <div class="loading">
      <div class="spinner"></div>
      <p>Loading...</p>
    </div>
  </div>

  <!-- Load modules -->
  <script type="module">
    // Import all modules
    import { SUPABASE_CONFIG } from './js/config.js';
    import { showToast, formatDate, formatDuration, formatCurrency, formatNumber, getDateRange } from './js/utils.js';
    import { renderLogin, renderSignup } from './js/auth.js';
    import { renderProfile } from './js/profile.js';
    import { renderDashboard, cleanupDashboard } from './js/dashboard.js';
    import { renderAdmin } from './js/admin.js';

    // Initialize Supabase client
    const { createClient } = supabase;
    window.supabaseClient = createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);

    // Make utilities globally available
    window.showToast = showToast;
    window.formatDate = formatDate;
    window.formatDuration = formatDuration;
    window.formatCurrency = formatCurrency;
    window.formatNumber = formatNumber;
    window.getDateRange = getDateRange;

    // Theme Support Logic
    window.toggleTheme = function () {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('integrix-theme', newTheme);

      // Update toggle icon
      updateThemeIcon();

      // Notify components that might need to redraw (like charts)
      window.dispatchEvent(new CustomEvent('themechanged', { detail: { theme: newTheme } }));
    };

    function updateThemeIcon() {
      const theme = document.documentElement.getAttribute('data-theme');
      const iconEl = document.getElementById('theme-icon');
      if (iconEl) {
        iconEl.innerHTML = theme === 'dark'
          ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>'
          : '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>';
      }
    }

    // Router
    class Router {
      constructor() {
        this.routes = {};
        this.currentRoute = null;
      }

      register(path, handler) {
        this.routes[path] = handler;
      }

      navigate(path) {
        if (this.routes[path]) {
          this.currentRoute = path;
          this.routes[path]();

          // Update active nav links
          document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
            if (link.dataset.route === path) {
              link.classList.add('active');
            }
          });
        }
      }

      init() {
        // Handle initial route
        const hash = window.location.hash.slice(1) || '/';
        this.navigate(hash);

        // Handle hash changes
        window.addEventListener('hashchange', () => {
          const newHash = window.location.hash.slice(1) || '/';
          this.navigate(newHash);
        });
      }
    }

    // Create global router
    window.router = new Router();

    // Authentication state
    let currentUser = null;
    let userProfile = null;
    let isAdmin = false;

    // Check authentication status
    async function checkAuth() {
      const { data: { session } } = await window.supabaseClient.auth.getSession();

      if (session) {
        currentUser = session.user;

        // Get user profile
        const { data: profile } = await window.supabaseClient
          .from('profiles')
          .select('*')
          .eq('id', currentUser.id)
          .single();

        userProfile = profile;

        // Check if user is admin
        const { data: roles } = await window.supabaseClient
          .from('user_roles')
          .select('role')
          .eq('user_id', currentUser.id);

        isAdmin = roles?.some(r => r.role === 'admin') || false;

        return true;
      }

      return false;
    }

    // Render navigation
    function renderNav() {
      const navContainer = document.getElementById('nav');

      if (!currentUser) {
        navContainer.innerHTML = '';
        return;
      }

      navContainer.innerHTML = `
        <nav class="nav">
          <div class="nav-container">
            <a href="#/" class="nav-brand">Integrix Dashboard</a>
            <div class="nav-links">
              <a class="nav-link" data-route="/" href="#/">Dashboard</a>
              <a class="nav-link" data-route="/profile" href="#/profile">Profile</a>
              ${isAdmin ? '<a class="nav-link" data-route="/admin" href="#/admin">Admin</a>' : ''}
              
              <button class="theme-toggle" onclick="toggleTheme()" id="theme-icon" title="Toggle Theme">
                <!-- Icon inserted by script -->
              </button>

              <button class="btn btn-logout" onclick="handleLogout()">Logout</button>
            </div>
          </div>
        </nav>
      `;
      updateThemeIcon();
    }

    // Logout handler
    window.handleLogout = async function () {
      await window.supabaseClient.auth.signOut();
      currentUser = null;
      userProfile = null;
      isAdmin = false;
      window.location.hash = '/login';
      showToast('Logged out successfully', 'success');
    };

    // Protected route wrapper
    async function protectedRoute(handler) {
      const isAuthenticated = await checkAuth();

      if (!isAuthenticated) {
        window.location.hash = '/login';
        return;
      }

      renderNav();
      handler();
    }

    // Public route wrapper
    async function publicRoute(handler) {
      const isAuthenticated = await checkAuth();

      if (isAuthenticated) {
        window.location.hash = '/';
        return;
      }

      document.getElementById('nav').innerHTML = '';
      handler();
    }

    // Register routes
    window.router.register('/login', () => publicRoute(renderLogin));
    window.router.register('/signup', () => publicRoute(renderSignup));
    window.router.register('/', () => protectedRoute(renderDashboard));
    window.router.register('/profile', () => protectedRoute(renderProfile));
    window.router.register('/admin', () => protectedRoute(renderAdmin));

    // Export app state
    window.appState = {
      getCurrentUser: () => currentUser,
      getUserProfile: () => userProfile,
      isAdmin: () => isAdmin,
      refreshAuth: checkAuth
    };

    // Initialize app
    window.addEventListener('DOMContentLoaded', () => {
      window.router.init();
    });

    // Initialize immediately if DOM is already loaded
    if (document.readyState === 'loading') {
      // Still loading
    } else {
      // DOM is ready
      window.router.init();
    }
  </script>
</body>

</html>